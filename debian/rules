#!/usr/bin/make -f

DEBIAN_NAME		:= CuprumBrowser
DEBIAN_VERSION		:= 0.2

DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)
DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
DEB_HOST_ARCH_CPU ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_CPU)
DEB_BUILD_ARCH ?= $(shell dpkg-architecture -qDEB_BUILD_ARCH)
DEB_BUILD_ARCH_BITS ?= $(shell dpkg-architecture -qDEB_BUILD_ARCH_BITS)

# needed for easy job control, e.g, kill %1
SHELL := /bin/bash

DEB_TAR_SRCDIR := .
SRC_DIR = $(CURDIR)
LIB_DIR        := usr/lib/$(DEBIAN_NAME)
BINARY_PACKAGE_COMPRESSION ?= xz
INSTALL_DIR = $(CURDIR)/debian/tmp/usr/local/cuprumbrowser
tmp_INSTALL_DIR=/usr/local/cuprumtest


#mainIn
build: build-stamp

# cmake config for webkit project
cmakeconfig:
	cmake -DCMAKE_PREFIX_PATH:PATH=$(tmp_INSTALL_DIR) -DCMAKE_INSTALL_PREFIX:PATH=$(tmp_INSTALL_DIR) -DCMAKE_INSTALL_LIBDIR:PATH=lib -DCMAKE_EXE_LINKER_FLAGS:STRING='-L/usr/local/cuprumtest/lib' -DPORT=GTK -DDEVELOPER_MODE=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_SKIP_BUILD_RPATH=FALSE -DCMAKE_BUILD_WITH_INSTALL_RPATH=FALSE -DCMAKE_INSTALL_RPATH=$(tmp_INSTALL_DIR)/lib -DCMAKE_INSTALL_RPATH_USE_LINK_PATH=TRUE

# Build webkit project.
build-stamp: cmakeconfig
	dh_testdir
	cd $(SRC_DIR) && $(MAKE) -j16
	touch $@

clean:
	dh_testdir
	dh_testroot
	dh_clean build-stamp
	rm -rf $(CURDIR)/CMakeFiles
	rm -f $(CURDIR)/CMakeCache.txt

install: build
	echo "Prepare install....."
	dh_testdir
	dh_testroot
	dh_clean -k 
	$(MAKE) install DESTDIR=$(CURDIR)/debian/tmp
	cp -rf $(CURDIR)/bin/resources $(CURDIR)/debian/tmp/usr/local/cuprumtest/bin/

binary-indep: build install

binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installchangelogs ChangeLog
	dh_installdocs
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
#	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
